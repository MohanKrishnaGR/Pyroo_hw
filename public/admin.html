<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fire Report Analytics Dashboard</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Leaflet.heat Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Your custom CSS styles -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #2c3e50;
            --light-bg: #f8f9fa;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .navbar-nav .nav-link {
            color: #fff;
            margin-right: 15px;
            transition: color 0.3s ease;
        }

        .navbar-nav .nav-link:hover {
            color: var(--secondary-color);
        }

        .navbar-nav .nav-link.active {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .dashboard-container {
            margin-top: 80px;
            padding: 20px;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        .stat-label {
            color: #666;
            margin: 0;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--secondary-color);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .feature-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
        }

        .feature-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--success-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .btn-logout {
            background-color: var(--accent-color);
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            color: white;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-logout:hover {
            background-color: #c0392b;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-right: 20px;
        }

        .search-bar input {
            border: none;
            outline: none;
            padding: 5px;
            width: 200px;
        }

        .search-bar i {
            color: #666;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .stats-container {
                flex-direction: column;
            }
            
            .search-bar {
                margin: 10px 0;
                width: 100%;
            }
            
            .search-bar input {
                width: 100%;
            }
        }

        /* Reports Section */
        .reports-section {
            margin-top: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
        }

        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .reports-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .report-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .report-image {
            width: 200px;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
        }

        .report-details {
            flex: 1;
        }

        .report-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9rem;
        }

        .report-meta i {
            margin-right: 5px;
        }

        .report-location {
            margin-top: 10px;
            color: var(--secondary-color);
        }

        .no-reports {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-reports i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        @media (max-width: 768px) {
            .report-card {
            flex-direction: column;
            }

            .report-image {
                width: 100%;
                height: 200px;
            }
        }

        /* Analytics Section */
        .analytics-section {
            margin-top: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
            display: none;
            width: 100%;
            overflow: hidden;
            position: relative; /* Add relative positioning */
        }

        /* Update analytics grid styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            clear: both; /* Clear any floats */
        }

        /* Add styles for the last grid section */
        .analytics-grid:last-child {
            margin-bottom: 20px; /* Add margin at the bottom */
        }

        /* Update chart container styles */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
            flex-shrink: 0;
        }

        .analytics-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .analytics-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .analytics-label {
            color: #666;
            font-size: 0.9rem;
        }

        .analytics-icon {
            font-size: 2rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .time-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-filter button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-filter button.active {
            background: var(--secondary-color);
            color: white;
        }

        /* Update map container styles */
        .map-container {
            height: 500px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            width: 100%;
            clear: both; /* Clear any floats */
            display: block; /* Ensure block display */
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 10px;
            position: absolute; /* Make map position absolute */
            top: 0;
            left: 0;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-controls .form-check {
            margin: 0;
        }

        .map-controls .form-check-input {
            margin-right: 5px;
        }

        .map-controls .form-check-label {
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }

        .map-loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--secondary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .cluster-marker {
            background: var(--secondary-color);
            border-radius: 50%;
            color: white;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Settings Section Styles */
        .settings-section {
            margin-top: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .settings-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .settings-icon {
            font-size: 1.5rem;
            color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .settings-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .settings-content {
            padding: 10px 0;
        }

        .form-check {
            margin-bottom: 15px;
        }

        .form-check-input:checked {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-approve {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-approve:hover {
            background-color: #27ae60;
        }

        .btn-deny {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-deny:hover {
            background-color: #c0392b;
        }

        .report-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: #fff;
        }

        .status-approved {
            background-color: var(--success-color);
            color: #fff;
        }

        .status-denied {
            background-color: var(--accent-color);
            color: #fff;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-shrink: 0; /* Prevent weather info from shrinking */
        }

        .weather-icon {
            font-size: 2rem;
        }

        /* Update prediction card styles */
        .prediction-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            min-height: 200px; /* Increased minimum height */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .prediction-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .prediction-time {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .prediction-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .prediction-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        .prediction-period {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .risk-factors {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 200px; /* Added max height */
            overflow-y: auto; /* Added scroll if content exceeds max height */
        }

        .risk-factors-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1rem;
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 0;
        }

        .risk-factor-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            padding: 5px 0;
        }

        .risk-factor-label {
            opacity: 0.9;
        }

        .risk-factor-value {
            font-weight: 500;
        }

        .time-series-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-shrink: 0; /* Prevent filters from shrinking */
        }

        .time-series-btn {
            padding: 5px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
        }

        .time-series-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        #timeSeriesChart {
            flex: 1; /* Make chart fill remaining space */
            min-height: 0; /* Important for flex child */
            width: 100%;
            position: relative;
        }

        /* Video Streaming Styles */
        .stream-status {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #95a5a6;
        }

        .status-indicator.connected {
            background-color: #2ecc71;
        }

        .status-indicator.disconnected {
            background-color: #e74c3c;
        }

        .stream-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .stream-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .stream-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
        }

        .stream-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .stream-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .loading-spinner i {
            font-size: 2rem;
        }

        .error-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .error-message i {
            font-size: 2rem;
            color: #e74c3c;
        }

        /* Predictive Analysis Section Styles */
        .predictive-analysis-section {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px;
            width: 100%;
        }

        .prediction-card {
            flex: 1;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            position: relative;
            z-index: 1;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .prediction-chart-container {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 20px;
            height: 400px;
        }

        /* Update chart container styles */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt"></i>
                Admin Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home"></i> Home</a>
                        </li>
                        <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-cog"></i> Settings</a>
                                </li>
                            </ul>
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search...">
                </div>
                <div class="position-relative">
                    <a href="#" class="nav-link">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </a>
                </div>
                <a href="index.html" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1); color: var(--success-color);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <p class="stat-value" id="totalReports">0</p>
                    <p class="stat-label">Total Reports</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1); color: var(--secondary-color);">
                    <i class="fas fa-video"></i>
                </div>
                <div class="stat-info">
                    <p class="stat-value" id="activeStreams">0</p>
                    <p class="stat-label">Active Streams</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1); color: var(--warning-color);">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-info">
                    <p class="stat-value" id="activeFires">0</p>
                    <p class="stat-label">Active Fires</p>
                </div>
            </div>
        </div>

        <div class="card-container">
            <a href="#" class="feature-card" id="usersQuery">
                <span class="feature-badge">New</span>
                <div class="feature-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="feature-title">Users Query</div>
                <div class="feature-description">Manage and view user queries and feedback</div>
            </a>
            <a href="#" class="feature-card" id="videoStreaming">
                <div class="feature-icon">
                    <i class="fas fa-video"></i>
                </div>
                <div class="feature-title">Video Streaming</div>
                <div class="feature-description">Access and manage video streaming services</div>
                <div class="stream-status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </a>
            <a href="#" class="feature-card" id="analyticsBtn">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="feature-title">Analytics</div>
                <div class="feature-description">View detailed analytics and reports</div>
            </a>
            <a href="#" class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="feature-title">Settings</div>
                <div class="feature-description">Configure system settings and preferences</div>
            </a>
        </div>

        <!-- Video Streaming Modal -->
        <div class="modal fade" id="videoStreamingModal" tabindex="-1" aria-labelledby="videoStreamingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="videoStreamingModalLabel">
                            <i class="fas fa-video"></i> Live Video Stream
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="stream-container">
                            <div class="stream-controls">
                                <button class="btn btn-primary" id="playPauseBtn">
                                    <i class="fas fa-play"></i> Play
                                </button>
                                <button class="btn btn-outline-secondary" id="qualityBtn">
                                    <i class="fas fa-tachometer-alt"></i> Quality
                                </button>
                                <div class="stream-info">
                                    <span class="stream-quality">Quality: Auto</span>
                                    <span class="stream-fps">FPS: --</span>
                                    <span class="stream-resolution">Resolution: --</span>
                                </div>
                            </div>
                            <div class="video-wrapper">
                                <img id="streamVideo" class="stream-video" 
                                     src="http://localhost:5050/" 
                                     alt="Live Video Stream">
                                <!-- Using img tag for MJPEG stream -->
                                <div class="stream-overlay">
                                    <div class="loading-spinner">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>Connecting to stream...</span>
                                    </div>
                                    <div class="error-message" style="display: none;">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span>Failed to connect to stream. Please try again.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="analytics-section" id="analyticsSection">
            <div class="reports-header">
                <h2 class="reports-title">Analytics Dashboard</h2>
                <div class="d-flex align-items-center gap-3">
                    <div class="time-filter">
                        <button class="active" onclick="filterData('day')">Today</button>
                        <button onclick="filterData('week')">This Week</button>
                        <button onclick="filterData('month')">This Month</button>
                        <button onclick="filterData('year')">This Year</button>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                        <div class="dropdown-menu p-3" style="min-width: 300px;">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="filterApproved" checked>
                                    <label class="form-check-label" for="filterApproved">Approved</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="filterPending" checked>
                                    <label class="form-check-label" for="filterPending">Pending</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="filterDenied" checked>
                                    <label class="form-check-label" for="filterDenied">Denied</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Response Time</label>
                                <select class="form-select" id="responseTimeFilter">
                                    <option value="all">All Times</option>
                                    <option value="fast">Fast (< 15 min)</option>
                                    <option value="medium">Medium (15-30 min)</option>
                                    <option value="slow">Slow (> 30 min)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" id="locationFilter" placeholder="Search by location...">
                            </div>
                            <button class="btn btn-primary w-100" onclick="applyFilters()">Apply Filters</button>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                            <li><a class="dropdown-item" href="#" onclick="exportData('csv')">CSV</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData('json')">JSON</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData('pdf')">PDF</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card">
                    <i class="fas fa-fire analytics-icon"></i>
                    <div class="analytics-value" id="totalFires">0</div>
                    <div class="analytics-label">Total Fire Reports</div>
                </div>
                <div class="analytics-card">
                    <i class="fas fa-map-marker-alt analytics-icon"></i>
                    <div class="analytics-value" id="activeLocations">0</div>
                    <div class="analytics-label">Active Locations</div>
                </div>
                <div class="analytics-card">
                    <i class="fas fa-chart-pie analytics-icon"></i>
                    <div class="analytics-value" id="responseTime">0</div>
                    <div class="analytics-label">Avg. Response Time (min)</div>
                </div>
            </div>

            <div class="analytics-grid" style="margin-top: 20px;">
                <!-- Time Series Analysis -->
                <div class="chart-container">
                    <h5 class="chart-title">Time Series Analysis</h5>
                    <div class="time-series-filters">
                        <button class="time-series-btn active" data-period="hour">By Hour</button>
                        <button class="time-series-btn" data-period="day">By Day</button>
                        <button class="time-series-btn" data-period="month">By Month</button>
                    </div>
                    <canvas id="timeSeriesChart"></canvas>
                </div>

                <!-- Weather Correlation -->
                <div class="chart-container">
                    <h5 class="chart-title">Weather Correlation</h5>
                    <div class="weather-info">
                        <i class="fas fa-temperature-high weather-icon"></i>
                        <div>
                            <div>Current Temperature: <span id="currentTemp">--</span>°C</div>
                            <div>Humidity: <span id="currentHumidity">--</span>%</div>
                            <div>Wind Speed: <span id="currentWind">--</span> km/h</div>
                        </div>
                    </div>
                    <canvas id="weatherChart"></canvas>
                </div>

                <!-- Predictive Analysis -->
                <div class="predictive-analysis-section">
                    <div class="prediction-card">
                        <div class="prediction-header">
                            <div class="prediction-title">Predicted Fire Risk Level</div>
                            <div class="prediction-time">Next 24 Hours</div>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-value" id="riskLevel">Medium</div>
                        </div>
                        <div class="risk-factors">
                            <div class="risk-factors-title">Risk Factors</div>
                            <div class="risk-factor-item">
                                <span class="risk-factor-label">Historical Incidents (7 days)</span>
                                <span class="risk-factor-value">0</span>
                            </div>
                            <div class="risk-factor-item">
                                <span class="risk-factor-label">Active Fires</span>
                                <span class="risk-factor-value">0</span>
                            </div>
                            <div class="risk-factor-item">
                                <span class="risk-factor-label">Weather Risk</span>
                                <span class="risk-factor-value">0%</span>
                            </div>
                            <div class="risk-factor-item">
                                <span class="risk-factor-label">Time of Day Risk</span>
                                <span class="risk-factor-value">0%</span>
                            </div>
                            <div class="risk-factor-item">
                                <span class="risk-factor-label">Day of Week Risk</span>
                                <span class="risk-factor-value">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="prediction-chart-container">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="settings-section" id="settingsSection" style="display: none;">
            <div class="reports-header">
                <h2 class="reports-title">System Settings</h2>
            </div>

            <div class="settings-grid">
                <div class="settings-card">
                    <div class="settings-header">
                        <i class="fas fa-bell settings-icon"></i>
                        <h3>Notification Settings</h3>
                    </div>
                    <div class="settings-content">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            <label class="form-check-label" for="emailNotifications">Email Notifications</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pushNotifications" checked>
                            <label class="form-check-label" for="pushNotifications">Push Notifications</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="criticalAlerts" checked>
                            <label class="form-check-label" for="criticalAlerts">Critical Alerts</label>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <i class="fas fa-shield-alt settings-icon"></i>
                        <h3>Security Settings</h3>
                    </div>
                    <div class="settings-content">
                        <div class="mb-3">
                            <label for="passwordChange" class="form-label">Change Password</label>
                            <input type="password" class="form-control" id="passwordChange" placeholder="New Password">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm Password">
                        </div>
                        <button class="btn btn-primary" onclick="updatePassword()">Update Password</button>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <i class="fas fa-cog settings-icon"></i>
                        <h3>System Preferences</h3>
                    </div>
                    <div class="settings-content">
                        <div class="mb-3">
                            <label for="timezone" class="form-label">Timezone</label>
                            <select class="form-select" id="timezone">
                                <option value="UTC">UTC</option>
                                <option value="EST">Eastern Time</option>
                                <option value="PST">Pacific Time</option>
                                <option value="IST">Indian Standard Time</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="language" class="form-label">Language</label>
                            <select class="form-select" id="language">
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="savePreferences()">Save Preferences</button>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-header">
                        <i class="fas fa-database settings-icon"></i>
                        <h3>Data Management</h3>
                    </div>
                    <div class="settings-content">
                        <div class="mb-3">
                            <label class="form-label">Data Retention</label>
                            <select class="form-select" id="dataRetention">
                                <option value="30">30 days</option>
                                <option value="90">90 days</option>
                                <option value="180">180 days</option>
                                <option value="365">1 year</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Backup Schedule</label>
                            <select class="form-select" id="backupSchedule">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="updateDataSettings()">Update Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div class="reports-section">
            <div class="reports-header">
                <h2 class="reports-title">Fire Reports</h2>
                <button class="btn btn-primary" onclick="refreshReports()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="reportsList">
                <!-- Reports will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        // Function to load and display reports
        async function loadReports() {
            try {
                const response = await fetch('/fire');
                const reports = await response.json();
                
                const reportsList = document.getElementById('reportsList');
                const totalReports = document.getElementById('totalReports');
                
                totalReports.textContent = reports.length;
                
                if (reports.length === 0) {
                    reportsList.innerHTML = `
                        <div class="no-reports">
                            <i class="fas fa-inbox"></i>
                            <p>No fire reports available</p>
                        </div>
                    `;
                    return;
                }

                reportsList.innerHTML = reports.map(report => {
                    // Format the date properly
                    const date = report.createdAt ? new Date(report.createdAt) : new Date();
                    const formattedDate = date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Get status class and text
                    const status = report.status || 'pending';
                    const statusClass = status === 'approved' ? 'status-approved' : 
                                     status === 'denied' ? 'status-denied' : 'status-pending';
                    const statusText = status === 'approved' ? 'Approved' : 
                                    status === 'denied' ? 'Denied' : 'Pending';

                    return `
                        <div class="report-card" data-id="${report._id}">
                            <img src="${report.imageUrl}" alt="Fire Report" class="report-image">
                            <div class="report-details">
                                <div class="report-meta">
                                    <span><i class="fas fa-phone"></i> ${report.phone || 'N/A'}</span>
                                    <span><i class="fas fa-clock"></i> ${formattedDate}</span>
                                    <span class="report-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="report-location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Latitude: ${report.latitude || 'N/A'}, Longitude: ${report.longitude || 'N/A'}
                                </div>
                                ${status === 'pending' ? `
                                    <div class="report-actions">
                                        <button class="btn-approve" onclick="handleReportAction('${report._id}', 'approve')">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button class="btn-deny" onclick="handleReportAction('${report._id}', 'deny')">
                                            <i class="fas fa-times"></i> Deny
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('reportsList').innerHTML = `
                    <div class="no-reports">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Error loading reports. Please try again.</p>
                    </div>
                `;
            }
        }

        // Function to handle report actions (approve/deny)
        async function handleReportAction(reportId, action) {
            try {
                // Map the action to the correct status value
                const status = action === 'approve' ? 'approved' : 'denied';
                console.log(`Updating report ${reportId} to status: ${status}`);
                
                const response = await fetch(`/fire/${reportId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response');
                }
                
                if (response.ok) {
                    // Refresh reports list
                    await loadReports();
                    
                    // Refresh analytics if visible
                    if (document.getElementById('analyticsSection').style.display === 'block') {
                        await loadAnalyticsData();
                        updateCharts(currentTimeRange);
                        updateMap(allReports);
                    }
                    
                    // Show success message
                    alert(`Report ${action}d successfully!`);
                } else {
                    throw new Error(data.error || 'Failed to update report status');
                }
            } catch (error) {
                console.error('Error updating report status:', error);
                alert(`Error updating report status: ${error.message}`);
            }
        }

        // Function to refresh reports
        function refreshReports() {
            loadReports();
        }

        // Load reports when page loads
        document.addEventListener('DOMContentLoaded', loadReports);

        // Analytics functionality
        let reportsChart, locationChart;
        let allReports = [];
        let currentTimeRange = 'day';
        let realTimeUpdateInterval;

        let activeFilters = {
            status: ['approved', 'pending', 'denied'],
            responseTime: 'all',
            location: ''
        };

        function initializeAnalytics() {
            try {
                console.log('Initializing analytics...');
                
                // Initialize map first
                initializeMap();
                
                // Load and process data
                loadAnalyticsData();
                
                // Start real-time updates
                startRealTimeUpdates();
                
                console.log('Analytics initialized successfully');
            } catch (error) {
                console.error('Error initializing analytics:', error);
            }
        }

        function startRealTimeUpdates() {
            // Clear any existing interval
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            
            // Update every 30 seconds
            realTimeUpdateInterval = setInterval(async () => {
                if (document.getElementById('analyticsSection').style.display === 'block') {
                    await loadAnalyticsData();
                    updateCharts(currentTimeRange);
                    updateMap(allReports);
                }
            }, 30000);
        }

        function initializeCharts() {
            const reportsCtx = document.getElementById('reportsChart').getContext('2d');
            const locationCtx = document.getElementById('locationChart').getContext('2d');

            // Destroy existing charts if they exist
            if (reportsChart) {
                reportsChart.destroy();
            }
            if (locationChart) {
                locationChart.destroy();
            }

            // Initialize Reports Chart with empty data
            reportsChart = new Chart(reportsCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Fire Reports',
                        data: Array(24).fill(0),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.1,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#e74c3c',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 10
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            locationChart = new Chart(locationCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#e74c3c',
                            '#3498db',
                            '#2ecc71',
                            '#f1c40f',
                            '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Weather API Integration
        const WEATHER_API_KEY = 'd0b3db98d5bfc392bfb6ad07f5af4e8a';
        const WEATHER_API_URL = 'https://api.openweathermap.org/data/2.5';

        // Default location (Coimbatore)
        const DEFAULT_LOCATION = {
            lat: 11.0168,
            lon: 76.9558
        };

        let currentWeatherLocation = DEFAULT_LOCATION;

        async function getWeatherData(lat, lon) {
            try {
                const response = await fetch(`${WEATHER_API_URL}/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric`);
                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching weather data:', error);
                return null;
            }
        }

        async function getWeatherForecast(lat, lon) {
            try {
                const response = await fetch(`${WEATHER_API_URL}/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric`);
                if (!response.ok) {
                    throw new Error(`Weather forecast API error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching weather forecast:', error);
                return null;
            }
        }

        // Weather Correlation
        async function initializeWeatherChart(reports, location = null) {
            try {
                // Use provided location or default to Coimbatore
                const targetLocation = location || DEFAULT_LOCATION;
                currentWeatherLocation = targetLocation;

                // Get weather data for the target location
                const weatherData = await getWeatherData(targetLocation.lat, targetLocation.lon);
                const forecastData = await getWeatherForecast(targetLocation.lat, targetLocation.lon);

            if (!weatherData || !forecastData) {
                console.error('Failed to fetch weather data');
                return;
            }

                // Update location display
                const locationDisplay = document.getElementById('weatherLocation');
                if (!locationDisplay) {
                    const weatherInfo = document.querySelector('.weather-info');
                    const locationSpan = document.createElement('div');
                    locationSpan.id = 'weatherLocation';
                    locationSpan.style.marginTop = '10px';
                    locationSpan.style.fontSize = '0.9rem';
                    locationSpan.style.color = '#666';
                    weatherInfo.appendChild(locationSpan);
                }
                document.getElementById('weatherLocation').textContent = 
                    `Location: ${weatherData.name || 'Coimbatore'}`;

            // Update current weather info
            document.getElementById('currentTemp').textContent = Math.round(weatherData.main.temp);
            document.getElementById('currentHumidity').textContent = weatherData.main.humidity;
                document.getElementById('currentWind').textContent = Math.round(weatherData.wind.speed * 3.6);

            // Prepare data for correlation chart
            const temperatureData = forecastData.list.map(item => Math.round(item.main.temp));
            const humidityData = forecastData.list.map(item => item.main.humidity);
            const windData = forecastData.list.map(item => Math.round(item.wind.speed * 3.6));
                
                // Format time labels to show both date and time
                const timeLabels = forecastData.list.map(item => {
                    const date = new Date(item.dt * 1000);
                    return date.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                });

            const ctx = document.getElementById('weatherChart').getContext('2d');
            
            if (weatherChart) {
                weatherChart.destroy();
            }

            weatherChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Temperature (°C)',
                            data: temperatureData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            yAxisID: 'y',
                            tension: 0.1
                        },
                        {
                            label: 'Humidity (%)',
                            data: humidityData,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.1
                        },
                        {
                            label: 'Wind Speed (km/h)',
                            data: windData,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            yAxisID: 'y2',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weather Conditions Forecast'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                    text: 'Date & Time'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: {
                                        size: 10
                                    }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Humidity (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Wind Speed (km/h)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });

            // Update weather icon based on current conditions
            const weatherIcon = document.querySelector('.weather-icon');
            const weatherCode = weatherData.weather[0].id;
            let iconClass = 'fa-cloud';

            if (weatherCode >= 200 && weatherCode < 300) {
                iconClass = 'fa-bolt';
            } else if (weatherCode >= 300 && weatherCode < 400) {
                iconClass = 'fa-cloud-rain';
            } else if (weatherCode >= 500 && weatherCode < 600) {
                iconClass = 'fa-cloud-showers-heavy';
            } else if (weatherCode >= 600 && weatherCode < 700) {
                iconClass = 'fa-snowflake';
            } else if (weatherCode >= 700 && weatherCode < 800) {
                iconClass = 'fa-smog';
            } else if (weatherCode === 800) {
                iconClass = 'fa-sun';
            } else if (weatherCode > 800) {
                iconClass = 'fa-cloud';
            }

            weatherIcon.className = `fas ${iconClass} weather-icon`;
            } catch (error) {
                console.error('Error initializing weather chart:', error);
            }
        }

        // Update the marker popup to include weather update functionality
        function updateMap(reports) {
            try {
                // Ensure map and markerCluster are initialized
                if (!map || !markerCluster) {
                    console.log('Map not initialized, initializing now...');
                    initializeMap();
                }

                // Clear existing markers
                clearMap();

                console.log('Updating map with reports:', reports);

                // Add new markers
                reports.forEach(report => {
                    // Skip reports without valid coordinates
                    if (!report.latitude || !report.longitude || 
                        report.latitude === '0' || report.longitude === '0') {
                        console.warn('Skipping report with invalid coordinates:', report);
                        return;
                    }

                    try {
                        const lat = parseFloat(report.latitude);
                        const lng = parseFloat(report.longitude);
                        
                        if (isNaN(lat) || isNaN(lng)) {
                            console.warn('Invalid coordinates for report:', report);
                            return;
                        }

                        const marker = L.marker([lat, lng], {
                            icon: getMarkerIcon(report)
                        });

                        // Add popup with report details and weather update button
                        marker.bindPopup(`
                            <div class="map-popup">
                                <h6>Fire Report Details</h6>
                                <p><strong>Time:</strong> ${new Date(report.createdAt || new Date()).toLocaleString()}</p>
                                <p><strong>Phone:</strong> ${report.phone || 'N/A'}</p>
                                <p><strong>Status:</strong> ${getStatusText(report.status)}</p>
                                ${report.imageUrl ? `<img src="${report.imageUrl}" style="max-width: 200px; margin-top: 10px;">` : ''}
                                <button class="btn btn-sm btn-primary mt-2" onclick="updateWeatherForLocation(${report.latitude}, ${report.longitude})">
                                    <i class="fas fa-cloud-sun"></i> Update Weather
                                </button>
                            </div>
                        `);

                        markers.push(marker);
                        markerCluster.addLayer(marker);
                    } catch (error) {
                        console.error('Error adding marker for report:', report, error);
                    }
                });

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                } else {
                    console.warn('No valid markers to display on map');
                }

                // Update heat map
                initializeHeatMap(reports);

            } catch (error) {
                console.error('Error updating map:', error);
                alert('Error updating map. Please try again.');
            }
        }

        // Function to update weather for a specific location
        function updateWeatherForLocation(lat, lon) {
            initializeWeatherChart(allReports, { lat, lon });
        }

        // Update the loadAnalyticsData function to use default location
        async function loadAnalyticsData() {
            try {
                const response = await fetch('/fire');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allReports = await response.json();
                console.log('Fetched reports:', allReports);
                
                // Filter reports by status
                const approvedReports = allReports.filter(report => report.status === 'approved');
                const pendingReports = allReports.filter(report => report.status === 'pending');
                const deniedReports = allReports.filter(report => report.status === 'denied');
                
                console.log('Filtered reports:', {
                    total: allReports.length,
                    approved: approvedReports.length,
                    pending: pendingReports.length,
                    denied: deniedReports.length
                });
                
                // Update analytics cards
                document.getElementById('totalFires').textContent = allReports.length;
                document.getElementById('activeLocations').textContent = 
                    new Set(allReports.map(r => `${r.latitude},${r.longitude}`)).size;
                
                // Calculate average response time
                const avgResponseTime = approvedReports.length > 0 ? 
                    Math.round(approvedReports.reduce((acc, report) => {
                        const createdAt = new Date(report.createdAt || new Date());
                        const updatedAt = new Date(report.updatedAt || report.createdAt || new Date());
                        const responseTime = (updatedAt - createdAt) / (1000 * 60);
                        return acc + responseTime;
                    }, 0) / approvedReports.length) : 0;
                document.getElementById('responseTime').textContent = avgResponseTime;
                
                // Initialize weather chart with default location
                await initializeWeatherChart(allReports);
                
                // Initialize heat map with real data
                initializeHeatMap(allReports);
                
                // Initialize time series chart with real data
                initializeTimeSeriesChart(allReports);
                
                // Update charts and map
                updateCharts(currentTimeRange);
                updateMap(allReports);
            } catch (error) {
                console.error('Error loading analytics data:', error);
                alert('Error loading analytics data. Please try again.');
            }
        }

        function updateCharts(timeRange) {
            currentTimeRange = timeRange;
            
            // Filter data based on time range
            const now = new Date();
            const filteredReports = allReports.filter(report => {
                const reportDate = new Date(report.createdAt || new Date());
                switch(timeRange) {
                    case 'day':
                        return reportDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        return reportDate >= weekAgo;
                    case 'month':
                        return reportDate.getMonth() === now.getMonth() && 
                               reportDate.getFullYear() === now.getFullYear();
                    case 'year':
                        return reportDate.getFullYear() === now.getFullYear();
                    default:
                        return true;
                }
            });

            console.log('Filtered reports for charts:', filteredReports);

            // Update time series chart if it exists
            if (timeSeriesChart) {
                const data = aggregateDataByPeriod(filteredReports, 'hour');
                timeSeriesChart.data.labels = data.labels;
                timeSeriesChart.data.datasets[0].data = data.values;
                timeSeriesChart.update();
            }

            // Update weather chart if it exists
            if (weatherChart) {
                // Update weather chart data here if needed
            }

            // Update prediction chart if it exists
            if (predictionChart) {
                // Update prediction chart data here if needed
            }
        }

        function filterData(timeRange) {
            // Update active button
            document.querySelectorAll('.time-filter button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update charts
            updateCharts(timeRange);
        }

        // Settings functionality
        document.querySelector('.feature-card:nth-child(4)').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('settingsSection').style.display = 'block';
            document.querySelector('.reports-section').style.display = 'none';
            document.getElementById('analyticsSection').style.display = 'none';
        });

        function updatePassword() {
            const newPassword = document.getElementById('passwordChange').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            // Here you would typically make an API call to update the password
            alert('Password updated successfully!');
        }

        function savePreferences() {
            const timezone = document.getElementById('timezone').value;
            const language = document.getElementById('language').value;

            // Here you would typically make an API call to save preferences
            alert('Preferences saved successfully!');
        }

        function updateDataSettings() {
            const retention = document.getElementById('dataRetention').value;
            const backup = document.getElementById('backupSchedule').value;

            // Here you would typically make an API call to update data settings
            alert('Data settings updated successfully!');
        }

        // Map functionality
        let map;
        let markers = [];
        let markerCluster;

        function initializeMap() {
            try {
                console.log('Initializing map...');
                
                // Remove any existing map instance
                if (map) {
                    map.remove();
                }

                // Initialize map centered on India
                map = L.map('map').setView([20.5937, 78.9629], 5);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Initialize marker cluster group
                markerCluster = L.markerClusterGroup();
                map.addLayer(markerCluster);

                // Add map controls
                addMapControls();
                addMapLegend();

                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                alert('Error initializing map. Please check your internet connection and try again.');
            }
        }

        function addMapControls() {
            const controls = document.createElement('div');
            controls.className = 'map-controls';
            controls.innerHTML = `
                <button class="btn btn-sm btn-primary" onclick="refreshMap()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="heatmapToggle">
                    <label class="form-check-label" for="heatmapToggle">Show Heat Map</label>
                </div>
            `;
            document.querySelector('.map-container').appendChild(controls);
        }

        function addMapLegend() {
            const legend = document.createElement('div');
            legend.className = 'map-legend';
            legend.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>Active Fire (Approved)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>Pending Review</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95a5a6;"></div>
                    <span>Resolved/Denied</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>Unknown Status</span>
                </div>
            `;
            document.querySelector('.map-container').appendChild(legend);
        }

        function clearMap() {
            try {
                if (markerCluster) {
                    markerCluster.clearLayers();
                }
                markers = [];
            } catch (error) {
                console.error('Error clearing map:', error);
            }
        }

        function refreshMap() {
            loadAnalyticsData();
        }

        // Add click handler for Users Query button
        document.getElementById('usersQuery').addEventListener('click', function(e) {
            e.preventDefault();
            // Hide other sections
            document.getElementById('analyticsSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
            // Show reports section
            document.querySelector('.reports-section').style.display = 'block';
            // Refresh reports
            loadReports();
        });

        // Update other section handlers to hide reports section
        document.getElementById('analyticsBtn').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('analyticsSection').style.display = 'block';
            document.querySelector('.reports-section').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
            
            // Initialize analytics
            initializeAnalytics();
            
            // Initialize time series chart
            initializeTimeSeriesChart(allReports);
            
            // Initialize prediction chart
            initializePredictionChart(allReports);
        });

        document.querySelector('.feature-card:nth-child(4)').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('settingsSection').style.display = 'block';
            document.querySelector('.reports-section').style.display = 'none';
            document.getElementById('analyticsSection').style.display = 'none';
        });

        // Update the reports section to be visible by default
        document.addEventListener('DOMContentLoaded', function() {
            // Show reports section by default
            document.querySelector('.reports-section').style.display = 'block';
            // Hide other sections
            document.getElementById('analyticsSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
            // Load initial reports
            loadReports();
        });

        function exportData(format) {
            const filteredReports = getFilteredReports();
            let data, filename, contentType;

            switch(format) {
                case 'csv':
                    data = convertToCSV(filteredReports);
                    filename = 'fire_reports.csv';
                    contentType = 'text/csv';
                    break;
                case 'json':
                    data = JSON.stringify(filteredReports, null, 2);
                    filename = 'fire_reports.json';
                    contentType = 'application/json';
                    break;
                case 'pdf':
                    // PDF generation would require a server endpoint
                    alert('PDF export coming soon!');
                    return;
            }

            const blob = new Blob([data], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function convertToCSV(reports) {
            const headers = ['ID', 'Status', 'Phone', 'Latitude', 'Longitude', 'Created At', 'Updated At'];
            const rows = reports.map(report => [
                report._id,
                report.status,
                report.phone || 'N/A',
                report.latitude,
                report.longitude,
                new Date(report.createdAt).toISOString(),
                new Date(report.updatedAt || report.createdAt).toISOString()
            ]);
            
            return [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        function getFilteredReports() {
            const now = new Date();
            return allReports.filter(report => {
                // Time range filter
                const reportDate = new Date(report.createdAt);
                let timeFilter = true;
                switch(currentTimeRange) {
                    case 'day':
                        timeFilter = reportDate.toDateString() === now.toDateString();
                        break;
                    case 'week':
                        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        timeFilter = reportDate >= weekAgo;
                        break;
                    case 'month':
                        timeFilter = reportDate.getMonth() === now.getMonth() && 
                                   reportDate.getFullYear() === now.getFullYear();
                        break;
                    case 'year':
                        timeFilter = reportDate.getFullYear() === now.getFullYear();
                        break;
                }
                
                // Status filter
                const statusFilter = activeFilters.status.includes(report.status);
                
                // Response time filter
                let responseTimeFilter = true;
                if (activeFilters.responseTime !== 'all') {
                    const createdAt = new Date(report.createdAt);
                    const updatedAt = new Date(report.updatedAt || report.createdAt);
                    const responseTime = (updatedAt - createdAt) / (1000 * 60); // in minutes
                    
                    switch(activeFilters.responseTime) {
                        case 'fast':
                            responseTimeFilter = responseTime < 15;
                            break;
                        case 'medium':
                            responseTimeFilter = responseTime >= 15 && responseTime <= 30;
                            break;
                        case 'slow':
                            responseTimeFilter = responseTime > 30;
                            break;
                    }
                }
                
                // Location filter
                const locationFilter = activeFilters.location === '' || 
                    `${report.latitude},${report.longitude}`.toLowerCase().includes(activeFilters.location);
                
                return timeFilter && statusFilter && responseTimeFilter && locationFilter;
            });
        }

        function applyFilters() {
            // Update active filters
            activeFilters.status = [];
            if (document.getElementById('filterApproved').checked) activeFilters.status.push('approved');
            if (document.getElementById('filterPending').checked) activeFilters.status.push('pending');
            if (document.getElementById('filterDenied').checked) activeFilters.status.push('denied');
            
            activeFilters.responseTime = document.getElementById('responseTimeFilter').value;
            activeFilters.location = document.getElementById('locationFilter').value.toLowerCase();
            
            // Update charts and map with filtered data
            updateCharts(currentTimeRange);
            updateMap(allReports);
        }

        // Add cleanup when leaving analytics section
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (realTimeUpdateInterval) {
                    clearInterval(realTimeUpdateInterval);
                }
            } else if (document.getElementById('analyticsSection').style.display === 'block') {
                startRealTimeUpdates();
            }
        });

        // Initialize new charts and visualizations
        let heatmapLayer = null;
        let timeSeriesChart = null;
        let weatherChart = null;
        let predictionChart = null;

        // Heat Map Implementation
        function initializeHeatMap(reports) {
            try {
                // Filter out reports with invalid coordinates
                const validReports = reports.filter(report => 
                    report.latitude && report.longitude && 
                    report.latitude !== '0' && report.longitude !== '0'
                );

                // Group reports by location and count occurrences
                const locationCounts = {};
                validReports.forEach(report => {
                    const key = `${report.latitude},${report.longitude}`;
                    locationCounts[key] = (locationCounts[key] || 0) + 1;
                });

                // Convert to heat map data format with intensity based on count
                const heatData = Object.entries(locationCounts).map(([location, count]) => {
                    const [lat, lng] = location.split(',').map(Number);
                    // Normalize the intensity to a value between 0 and 1
                    const maxCount = Math.max(...Object.values(locationCounts));
                    const normalizedIntensity = count / maxCount;
                    return [lat, lng, normalizedIntensity];
                });

                console.log('Heat map data with normalized intensities:', heatData);

                // Remove existing heat layer if it exists
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                }

                // Create new heat layer with dynamic radius based on count
                heatmapLayer = L.heatLayer(heatData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 10,
                    minOpacity: 0.5,
                    gradient: {
                        0.1: '#2ecc71',  // Green for low intensity
                        0.3: '#f1c40f',  // Yellow for medium intensity
                        0.6: '#e67e22',  // Orange for high intensity
                        1.0: '#e74c3c'   // Red for very high intensity
                    }
                });

                // Add event listener for heat map toggle
                const heatmapToggle = document.getElementById('heatmapToggle');
                if (heatmapToggle) {
                    heatmapToggle.addEventListener('change', function(e) {
                        if (e.target.checked) {
                            map.addLayer(heatmapLayer);
                        } else {
                            map.removeLayer(heatmapLayer);
                        }
                    });
                }

                // Add heat map to the map if toggle is checked
                if (heatmapToggle && heatmapToggle.checked) {
                    map.addLayer(heatmapLayer);
                }

            } catch (error) {
                console.error('Error initializing heat map:', error);
            }
        }

        // Time Series Analysis
        function initializeTimeSeriesChart(reports) {
            try {
                const ctx = document.getElementById('timeSeriesChart').getContext('2d');
                
                function updateTimeSeriesChart(period) {
                    const data = aggregateDataByPeriod(reports, period);
                    
                    if (timeSeriesChart) {
                        timeSeriesChart.destroy();
                    }

                    timeSeriesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'Fire Incidents',
                                data: data.values,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.1,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointBackgroundColor: '#e74c3c',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Fire Incidents by ${period.charAt(0).toUpperCase() + period.slice(1)}`,
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 10,
                                    callbacks: {
                                        label: function(context) {
                                            return `Incidents: ${context.parsed.y}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        precision: 0,
                                        font: {
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                }

                // Add event listeners for period buttons
                document.querySelectorAll('.time-series-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.time-series-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        updateTimeSeriesChart(this.dataset.period);
                    });
                });

                // Initialize with hourly data
                updateTimeSeriesChart('hour');
            } catch (error) {
                console.error('Error initializing time series chart:', error);
            }
        }

        function aggregateDataByPeriod(reports, period) {
            try {
                const now = new Date();
                let labels = [];
                let values = [];

                switch(period) {
                    case 'hour':
                        // Initialize array for 24 hours
                        for (let i = 0; i < 24; i++) {
                            labels.push(`${i}:00`);
                            values.push(0);
                        }
                        // Count reports for each hour
                        reports.forEach(report => {
                            const reportDate = new Date(report.createdAt || new Date());
                            const hour = reportDate.getHours();
                            values[hour]++;
                        });
                        break;

                    case 'day':
                        // Initialize array for last 7 days
                        for (let i = 6; i >= 0; i--) {
                            const date = new Date();
                            date.setDate(date.getDate() - i);
                            labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                            values.push(0);
                        }
                        
                        // Count reports for each day
                        reports.forEach(report => {
                            const reportDate = new Date(report.createdAt || new Date());
                            // Reset time part to compare only dates
                            const reportDay = new Date(reportDate.getFullYear(), reportDate.getMonth(), reportDate.getDate());
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            
                            // Calculate days difference
                            const dayDiff = Math.floor((today - reportDay) / (1000 * 60 * 60 * 24));
                            
                            // Only count reports from the last 7 days
                            if (dayDiff >= 0 && dayDiff < 7) {
                                values[6 - dayDiff]++;
                            }
                        });
                        break;

                    case 'month':
                        // Initialize array for 12 months
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        labels = months;
                        values = Array(12).fill(0);
                        
                        // Count reports for each month
                        reports.forEach(report => {
                            const reportDate = new Date(report.createdAt || new Date());
                            const month = reportDate.getMonth();
                            values[month]++;
                        });
                        break;
                }

                console.log(`Time series data for ${period}:`, { labels, values });
                return { labels, values };
            } catch (error) {
                console.error('Error aggregating data by period:', error);
                return { labels: [], values: [] };
            }
        }

        // Predictive Analysis
        function initializePredictionChart(reports) {
            try {
                const ctx = document.getElementById('predictionChart').getContext('2d');
                
                // Get historical data for the last 7 days
                const now = new Date();
                const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                const historicalReports = reports.filter(report => 
                    new Date(report.createdAt) >= sevenDaysAgo
                );

                // Calculate base risk factors
                const riskFactors = {
                    historicalIncidents: historicalReports.length,
                    activeFires: reports.filter(r => r.status === 'approved').length,
                    weatherRisk: calculateWeatherRisk(),
                    timeOfDay: calculateTimeOfDayRisk(),
                    dayOfWeek: calculateDayOfWeekRisk()
                };

                // Generate predictions for next 24 hours
                const predictions = generatePredictions(riskFactors);
                
                // Update the prediction chart
                if (predictionChart) {
                    predictionChart.destroy();
                }

                predictionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: predictions.labels,
                        datasets: [{
                            label: 'Predicted Risk Level',
                            data: predictions.values,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '24-Hour Risk Prediction',
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Risk Level: ${context.parsed.y}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Risk Level (%)',
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                ticks: {
                                    padding: 10
                                }
                            },
                            x: {
                                ticks: {
                                    padding: 10
                                }
                            }
                        }
                    }
                });

                // Update prediction card content
                const predictionCard = document.querySelector('.prediction-card');
                predictionCard.innerHTML = `
                    <div class="prediction-header">
                        <div class="prediction-title">Predicted Fire Risk Level</div>
                        <div class="prediction-time">Next 24 Hours</div>
                    </div>
                    <div class="prediction-content">
                        <div class="prediction-value" id="riskLevel">Medium</div>
                    </div>
                    <div class="risk-factors">
                        <div class="risk-factors-title">Risk Factors</div>
                        <div class="risk-factor-item">
                            <span class="risk-factor-label">Historical Incidents (7 days)</span>
                            <span class="risk-factor-value">${riskFactors.historicalIncidents}</span>
                        </div>
                        <div class="risk-factor-item">
                            <span class="risk-factor-label">Active Fires</span>
                            <span class="risk-factor-value">${riskFactors.activeFires}</span>
                        </div>
                        <div class="risk-factor-item">
                            <span class="risk-factor-label">Weather Risk</span>
                            <span class="risk-factor-value">${riskFactors.weatherRisk}%</span>
                        </div>
                        <div class="risk-factor-item">
                            <span class="risk-factor-label">Time of Day Risk</span>
                            <span class="risk-factor-value">${riskFactors.timeOfDay}%</span>
                        </div>
                        <div class="risk-factor-item">
                            <span class="risk-factor-label">Day of Week Risk</span>
                            <span class="risk-factor-value">${riskFactors.dayOfWeek}%</span>
                        </div>
                    </div>
                `;

                // Update risk level display
                const riskLevel = document.getElementById('riskLevel');
                const currentRisk = predictions.values[0];
                
                let riskText, riskColor;
                if (currentRisk > 80) {
                    riskText = 'High';
                    riskColor = '#e74c3c';
                } else if (currentRisk > 60) {
                    riskText = 'Medium';
                    riskColor = '#f39c12';
                } else {
                    riskText = 'Low';
                    riskColor = '#2ecc71';
                }
                
                riskLevel.textContent = riskText;
                riskLevel.style.color = riskColor;

            } catch (error) {
                console.error('Error initializing prediction chart:', error);
            }
        }

        function calculateWeatherRisk() {
            // Get current weather data
            const currentTemp = parseFloat(document.getElementById('currentTemp').textContent);
            const currentHumidity = parseFloat(document.getElementById('currentHumidity').textContent);
            const currentWind = parseFloat(document.getElementById('currentWind').textContent);

            // Calculate risk based on weather conditions
            let risk = 0;
            
            // Temperature risk (higher risk at higher temperatures)
            if (currentTemp > 35) risk += 40;
            else if (currentTemp > 30) risk += 30;
            else if (currentTemp > 25) risk += 20;
            else risk += 10;

            // Humidity risk (higher risk at lower humidity)
            if (currentHumidity < 30) risk += 30;
            else if (currentHumidity < 50) risk += 20;
            else if (currentHumidity < 70) risk += 10;
            else risk += 5;

            // Wind risk (higher risk at higher wind speeds)
            if (currentWind > 20) risk += 30;
            else if (currentWind > 15) risk += 20;
            else if (currentWind > 10) risk += 10;
            else risk += 5;

            return Math.min(100, Math.round(risk));
        }

        function calculateTimeOfDayRisk() {
            const hour = new Date().getHours();
            
            // Higher risk during peak hours (9 AM - 5 PM)
            if (hour >= 9 && hour <= 17) return 70;
            // Medium risk during evening (5 PM - 9 PM)
            if (hour >= 17 && hour <= 21) return 50;
            // Lower risk during night (9 PM - 9 AM)
            return 30;
        }

        function calculateDayOfWeekRisk() {
            const day = new Date().getDay();
            
            // Higher risk on weekends
            if (day === 0 || day === 6) return 70;
            // Medium risk on Fridays
            if (day === 5) return 60;
            // Lower risk on weekdays
            return 40;
        }

        function generatePredictions(riskFactors) {
            const now = new Date();
            const labels = [];
            const values = [];
            
            // Generate predictions for next 24 hours
            for (let i = 0; i < 24; i++) {
                const futureDate = new Date(now.getTime() + i * 60 * 60 * 1000);
                labels.push(futureDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                }));
                
                // Calculate risk for this hour
                let risk = 0;
                
                // Base risk from historical data
                risk += (riskFactors.historicalIncidents * 5);
                
                // Active fires increase risk
                risk += (riskFactors.activeFires * 10);
                
                // Weather risk
                risk += riskFactors.weatherRisk;
                
                // Time of day risk
                risk += riskFactors.timeOfDay;
                
                // Day of week risk
                risk += riskFactors.dayOfWeek;
                
                // Add some randomness to simulate uncertainty
                risk += (Math.random() * 10 - 5);
                
                // Normalize risk to 0-100 range
                values.push(Math.min(100, Math.max(0, Math.round(risk / 3))));
            }
            
            return { labels, values };
        }

        // Video Streaming Functionality
        document.getElementById('videoStreaming').addEventListener('click', function(e) {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('videoStreamingModal'));
            modal.show();
            initializeStream();
        });

        function initializeStream() {
            const video = document.getElementById('streamVideo');
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('.status-text');
            const loadingSpinner = document.querySelector('.loading-spinner');
            const errorMessage = document.querySelector('.error-message');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const qualityBtn = document.getElementById('qualityBtn');

            // Reset UI
            loadingSpinner.style.display = 'flex';
            errorMessage.style.display = 'none';
            statusIndicator.classList.remove('connected', 'disconnected');
            statusText.textContent = 'Connecting...';
            
            // Handle video events
            video.addEventListener('loadeddata', () => {
                loadingSpinner.style.display = 'none';
                statusIndicator.classList.add('connected');
                statusText.textContent = 'Connected';
                updateStreamInfo();
            });

            video.addEventListener('error', () => {
                loadingSpinner.style.display = 'none';
                errorMessage.style.display = 'flex';
                statusIndicator.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
            });

            // Play/Pause button functionality
            playPauseBtn.addEventListener('click', () => {
                if (video.paused) {
                    video.play();
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                } else {
                    video.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                }
            });
        }
        
        // Update stream information (for MJPEG)
        function updateStreamInfo() {
            // You won't be able to directly access FPS or resolution 
            // with an <img> tag like you would with a <video> element.
            // You could implement custom logic here if needed,
            // but for a basic implementation, just leave it as "N/A"
            document.querySelector('.stream-fps').textContent = 'FPS: N/A';
            document.querySelector('.stream-resolution').textContent = 'Resolution: N/A';
        }
        
        // Trigger initial update
        updateStreamInfo();


    
        function getMarkerIcon(report) {
            // Ensure status is properly normalized
            const status = (report.status || 'pending').toLowerCase();
            let color, icon, title;
            
            console.log('Report status processing:', {
                reportId: report._id,
                originalStatus: report.status,
                normalizedStatus: status
            });
            
            switch(status) {
                case 'approved':
                    color = '#e74c3c'; // Red for active fires
                    icon = 'fa-fire';
                    title = 'Active Fire';
                    break;
                case 'pending':
                    color = '#f39c12'; // Orange for pending
                    icon = 'fa-clock';
                    title = 'Pending Review';
                    break;
                case 'denied':
                    color = '#95a5a6'; // Gray for denied
                    icon = 'fa-ban';
                    title = 'Resolved/Denied';
                    break;
                default:
                    color = '#3498db'; // Blue for unknown
                    icon = 'fa-question';
                    title = 'Unknown Status';
                    console.warn('Unknown status detected:', status);
            }

            console.log('Marker color assignment:', {
                reportId: report._id,
                status: status,
                assignedColor: color
            });

            return L.divIcon({
                className: 'cluster-marker',
                html: `<i class="fas ${icon}" title="${title}"></i>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15],
                style: `
                    background: ${color};
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    cursor: pointer;
                `
            });
        }

        function getStatusText(status) {
            switch(status) {
                case 'approved': return 'Active Fire';
                case 'pending': return 'Pending Review';
                case 'denied': return 'Resolved/Denied';
                default: return 'Unknown Status';
            }
        }
    </script>
</body>

</html>